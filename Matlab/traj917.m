% count = 0;
% formatSpec = '/Users/lingqiujin/move_large/t/t/0%d.png';
% 
% for i = 1:1:38
%     path = sprintf(formatSpec,i);
%     count = count+1;
%     imageFileNames{count} = path;
% end
%%
imageFileNames = {'/Users/lingqiujin/move_short/rgb/1537363936.254503675.png',...
    '/Users/lingqiujin/move_short/rgb/1537363936.424427480.png',...
    '/Users/lingqiujin/move_short/rgb/1537363936.591684858.png',...
    '/Users/lingqiujin/move_short/rgb/1537363936.757731439.png',...
    '/Users/lingqiujin/move_short/rgb/1537363936.925652348.png',...
    '/Users/lingqiujin/move_short/rgb/1537363937.094340699.png',...
    '/Users/lingqiujin/move_short/rgb/1537363937.261623021.png',...
    '/Users/lingqiujin/move_short/rgb/1537363937.430000455.png',...
    '/Users/lingqiujin/move_short/rgb/1537363937.597461298.png',...
    '/Users/lingqiujin/move_short/rgb/1537363937.766885137.png',...
    '/Users/lingqiujin/move_short/rgb/1537363937.935300391.png',...
    '/Users/lingqiujin/move_short/rgb/1537363938.101771368.png',...
    '/Users/lingqiujin/move_short/rgb/1537363938.271401157.png',...
    '/Users/lingqiujin/move_short/rgb/1537363938.440677855.png',...
    '/Users/lingqiujin/move_short/rgb/1537363938.605655966.png',...
    '/Users/lingqiujin/move_short/rgb/1537363938.773700804.png',...
    '/Users/lingqiujin/move_short/rgb/1537363938.945826059.png',...
    '/Users/lingqiujin/move_short/rgb/1537363939.111825158.png',...
    '/Users/lingqiujin/move_short/rgb/1537363939.277752714.png',...
    '/Users/lingqiujin/move_short/rgb/1537363939.447423212.png',...
    '/Users/lingqiujin/move_short/rgb/1537363939.613347982.png',...
    '/Users/lingqiujin/move_short/rgb/1537363939.783243758.png',...
    '/Users/lingqiujin/move_short/rgb/1537363939.949722910.png',...
    '/Users/lingqiujin/move_short/rgb/1537363940.117475811.png',...
    '/Users/lingqiujin/move_short/rgb/1537363940.285062303.png',...
    '/Users/lingqiujin/move_short/rgb/1537363940.453180007.png',...
    '/Users/lingqiujin/move_short/rgb/1537363940.622387312.png',...
    '/Users/lingqiujin/move_short/rgb/1537363940.792346070.png',...
    '/Users/lingqiujin/move_short/rgb/1537363940.959778215.png',...
    '/Users/lingqiujin/move_short/rgb/1537363941.126075724.png',...
    '/Users/lingqiujin/move_short/rgb/1537363941.296476589.png',...
    '/Users/lingqiujin/move_short/rgb/1537363941.463908147.png',...
    '/Users/lingqiujin/move_short/rgb/1537363941.630679722.png',...
    '/Users/lingqiujin/move_short/rgb/1537363941.799119969.png',...
    '/Users/lingqiujin/move_short/rgb/1537363941.965210266.png',...
    '/Users/lingqiujin/move_short/rgb/1537363942.136009542.png',...
    '/Users/lingqiujin/move_short/rgb/1537363942.301325684.png',...
    '/Users/lingqiujin/move_short/rgb/1537363942.468612255.png',...
    '/Users/lingqiujin/move_short/rgb/1537363942.637011748.png',...
    '/Users/lingqiujin/move_short/rgb/1537363942.804941921.png',...
    '/Users/lingqiujin/move_short/rgb/1537363942.973202583.png',...
    '/Users/lingqiujin/move_short/rgb/1537363943.141169522.png',...
    '/Users/lingqiujin/move_short/rgb/1537363943.308975744.png',...
    '/Users/lingqiujin/move_short/rgb/1537363943.477640926.png',...
    '/Users/lingqiujin/move_short/rgb/1537363943.646061468.png',...
    '/Users/lingqiujin/move_short/rgb/1537363943.813364059.png',...
    '/Users/lingqiujin/move_short/rgb/1537363943.981235241.png',...
    '/Users/lingqiujin/move_short/rgb/1537363944.183371983.png',...
    '/Users/lingqiujin/move_short/rgb/1537363944.355326444.png',...
    '/Users/lingqiujin/move_short/rgb/1537363944.551936171.png',...
    '/Users/lingqiujin/move_short/rgb/1537363944.720579047.png',...
    '/Users/lingqiujin/move_short/rgb/1537363944.890026257.png',...
    '/Users/lingqiujin/move_short/rgb/1537363945.058251389.png',...
    '/Users/lingqiujin/move_short/rgb/1537363945.224537879.png',...
    '/Users/lingqiujin/move_short/rgb/1537363945.392742538.png',...
    '/Users/lingqiujin/move_short/rgb/1537363946.736117554.png',...
    '/Users/lingqiujin/move_short/rgb/1537363946.904385638.png',...
    '/Users/lingqiujin/move_short/rgb/1537363947.072304998.png',...
    '/Users/lingqiujin/move_short/rgb/1537363947.244134796.png',...
    '/Users/lingqiujin/move_short/rgb/1537363947.408363082.png',...
    '/Users/lingqiujin/move_short/rgb/1537363947.578644606.png',...
    '/Users/lingqiujin/move_short/rgb/1537363947.746532755.png',...
    '/Users/lingqiujin/move_short/rgb/1537363947.912157625.png',...
    '/Users/lingqiujin/move_short/rgb/1537363948.081448058.png',...
    '/Users/lingqiujin/move_short/rgb/1537363948.249559571.png',...
    '/Users/lingqiujin/move_short/rgb/1537363948.416380271.png',...
    '/Users/lingqiujin/move_short/rgb/1537363948.584925991.png',...
    '/Users/lingqiujin/move_short/rgb/1537363948.752080281.png',...
    '/Users/lingqiujin/move_short/rgb/1537363948.920548556.png',...
    '/Users/lingqiujin/move_short/rgb/1537363949.090496493.png',...
    '/Users/lingqiujin/move_short/rgb/1537363949.256428273.png',...
    '/Users/lingqiujin/move_short/rgb/1537363949.424553154.png',...
    '/Users/lingqiujin/move_short/rgb/1537363949.597032074.png',...
    '/Users/lingqiujin/move_short/rgb/1537363949.762616317.png',...
    '/Users/lingqiujin/move_short/rgb/1537363949.929699862.png',...
    '/Users/lingqiujin/move_short/rgb/1537363950.432306463.png',...
    '/Users/lingqiujin/move_short/rgb/1537363950.600567308.png',...
    '/Users/lingqiujin/move_short/rgb/1537363952.784980684.png',...
    '/Users/lingqiujin/move_short/rgb/1537363952.951834160.png',...
    '/Users/lingqiujin/move_short/rgb/1537363953.657004900.png',...
    '/Users/lingqiujin/move_short/rgb/1537363953.825217677.png',...
    '/Users/lingqiujin/move_short/rgb/1537363953.994719356.png',...
    '/Users/lingqiujin/move_short/rgb/1537363954.160905119.png',...
    '/Users/lingqiujin/move_short/rgb/1537363954.331015844.png',...
    '/Users/lingqiujin/move_short/rgb/1537363954.497365523.png',...
    '/Users/lingqiujin/move_short/rgb/1537363954.665021521.png',...
    '/Users/lingqiujin/move_short/rgb/1537363954.834727484.png',...
    '/Users/lingqiujin/move_short/rgb/1537363955.001349432.png',...
    '/Users/lingqiujin/move_short/rgb/1537363955.168959559.png',...
    '/Users/lingqiujin/move_short/rgb/1537363955.339192053.png',...
    '/Users/lingqiujin/move_short/rgb/1537363955.505346577.png',...
    '/Users/lingqiujin/move_short/rgb/1537363955.673603102.png',...
    '/Users/lingqiujin/move_short/rgb/1537363955.842439727.png',...
    '/Users/lingqiujin/move_short/rgb/1537363956.008636878.png',...
    '/Users/lingqiujin/move_short/rgb/1537363956.176779585.png',...
    '/Users/lingqiujin/move_short/rgb/1537363956.346953746.png',...
    '/Users/lingqiujin/move_short/rgb/1537363956.512850753.png',...
    '/Users/lingqiujin/move_short/rgb/1537363956.682609437.png',...
    '/Users/lingqiujin/move_short/rgb/1537363956.849315486.png',...
    '/Users/lingqiujin/move_short/rgb/1537363957.016612870.png',...
    '/Users/lingqiujin/move_short/rgb/1537363957.187553962.png',...
    '/Users/lingqiujin/move_short/rgb/1537363957.352862338.png',...
    '/Users/lingqiujin/move_short/rgb/1537363957.520701954.png',...
    '/Users/lingqiujin/move_short/rgb/1537363957.690516152.png',...
    '/Users/lingqiujin/move_short/rgb/1537363957.856792496.png',...
    '/Users/lingqiujin/move_short/rgb/1537363958.025061708.png',...
    '/Users/lingqiujin/move_short/rgb/1537363958.195170957.png',...
    '/Users/lingqiujin/move_short/rgb/1537363958.360806804.png',...
    '/Users/lingqiujin/move_short/rgb/1537363958.531238725.png',...
    '/Users/lingqiujin/move_short/rgb/1537363958.699995370.png',...
    '/Users/lingqiujin/move_short/rgb/1537363958.864755957.png',...
    '/Users/lingqiujin/move_short/rgb/1537363959.035698485.png',...
    '/Users/lingqiujin/move_short/rgb/1537363959.201374845.png',...
    '/Users/lingqiujin/move_short/rgb/1537363959.368892104.png',...
    '/Users/lingqiujin/move_short/rgb/1537363959.541659420.png',...
    '/Users/lingqiujin/move_short/rgb/1537363959.705154300.png',...
    '/Users/lingqiujin/move_short/rgb/1537363959.874218682.png',...
    '/Users/lingqiujin/move_short/rgb/1537363960.042184029.png',...
    '/Users/lingqiujin/move_short/rgb/1537363960.209816675.png',...
    '/Users/lingqiujin/move_short/rgb/1537363960.378326710.png',...
    '/Users/lingqiujin/move_short/rgb/1537363960.546904128.png',...
    '/Users/lingqiujin/move_short/rgb/1537363960.713555967.png',...
    '/Users/lingqiujin/move_short/rgb/1537363960.881472926.png',...
    '/Users/lingqiujin/move_short/rgb/1537363961.050503771.png',...
    '/Users/lingqiujin/move_short/rgb/1537363961.217617638.png',...
    '/Users/lingqiujin/move_short/rgb/1537363961.387751497.png',...
    '/Users/lingqiujin/move_short/rgb/1537363961.553901974.png',...
    '/Users/lingqiujin/move_short/rgb/1537363961.721424580.png',...
    '/Users/lingqiujin/move_short/rgb/1537363961.894242089.png',...
    '/Users/lingqiujin/move_short/rgb/1537363962.057787135.png',...
    '/Users/lingqiujin/move_short/rgb/1537363962.225813544.png',...
    '/Users/lingqiujin/move_short/rgb/1537363962.396999142.png',...
    '/Users/lingqiujin/move_short/rgb/1537363962.561729857.png',...
    '/Users/lingqiujin/move_short/rgb/1537363962.729985227.png',...
    '/Users/lingqiujin/move_short/rgb/1537363962.898807144.png',...
    '/Users/lingqiujin/move_short/rgb/1537363963.066197558.png',...
    '/Users/lingqiujin/move_short/rgb/1537363963.233493563.png',...
    '/Users/lingqiujin/move_short/rgb/1537363963.401046412.png',...
    '/Users/lingqiujin/move_short/rgb/1537363963.568963097.png',...
    '/Users/lingqiujin/move_short/rgb/1537363963.738279077.png',...
    '/Users/lingqiujin/move_short/rgb/1537363963.904471461.png',...
    '/Users/lingqiujin/move_short/rgb/1537363964.072462616.png',...
    '/Users/lingqiujin/move_short/rgb/1537363964.240819141.png',...
    '/Users/lingqiujin/move_short/rgb/1537363964.408105901.png',...
    '/Users/lingqiujin/move_short/rgb/1537363964.577142454.png',...
    '/Users/lingqiujin/move_short/rgb/1537363964.747479856.png',...
    '/Users/lingqiujin/move_short/rgb/1537363964.913124477.png',...
    '/Users/lingqiujin/move_short/rgb/1537363965.080524511.png',...
    '/Users/lingqiujin/move_short/rgb/1537363965.249802229.png',...
    '/Users/lingqiujin/move_short/rgb/1537363965.416702512.png',...
    '/Users/lingqiujin/move_short/rgb/1537363965.585989600.png',...
    '/Users/lingqiujin/move_short/rgb/1537363965.753948911.png',...
    '/Users/lingqiujin/move_short/rgb/1537363965.922075755.png',...
    '/Users/lingqiujin/move_short/rgb/1537363966.087711958.png',...
    '/Users/lingqiujin/move_short/rgb/1537363966.255833487.png',...
    '/Users/lingqiujin/move_short/rgb/1537363966.424226272.png',...
    '/Users/lingqiujin/move_short/rgb/1537363966.593542949.png',...
    '/Users/lingqiujin/move_short/rgb/1537363966.760117539.png',...
    '/Users/lingqiujin/move_short/rgb/1537363966.928413417.png',...
    '/Users/lingqiujin/move_short/rgb/1537363967.097251168.png',...
    '/Users/lingqiujin/move_short/rgb/1537363967.265674904.png',...
    '/Users/lingqiujin/move_short/rgb/1537363967.433982763.png',...
    '/Users/lingqiujin/move_short/rgb/1537363967.600316239.png',...
    '/Users/lingqiujin/move_short/rgb/1537363967.767852463.png',...
    '/Users/lingqiujin/move_short/rgb/1537363967.936782179.png',...
    '/Users/lingqiujin/move_short/rgb/1537363968.104009522.png',...
    '/Users/lingqiujin/move_short/rgb/1537363968.273149109.png',...
    '/Users/lingqiujin/move_short/rgb/1537363968.440620863.png',...
    '/Users/lingqiujin/move_short/rgb/1537363968.610740092.png',...
    '/Users/lingqiujin/move_short/rgb/1537363968.779022033.png',...
    '/Users/lingqiujin/move_short/rgb/1537363968.945452597.png',...
    '/Users/lingqiujin/move_short/rgb/1537363969.113626666.png',...
    '/Users/lingqiujin/move_short/rgb/1537363969.283878954.png',...
    '/Users/lingqiujin/move_short/rgb/1537363969.450934592.png',...
    '/Users/lingqiujin/move_short/rgb/1537363969.618690857.png',...
    '/Users/lingqiujin/move_short/rgb/1537363969.786447305.png',...
    '/Users/lingqiujin/move_short/rgb/1537363969.953934587.png',...
    '/Users/lingqiujin/move_short/rgb/1537363970.120465277.png',...
    '/Users/lingqiujin/move_short/rgb/1537363970.288315242.png',...
    '/Users/lingqiujin/move_short/rgb/1537363970.456518913.png',...
    '/Users/lingqiujin/move_short/rgb/1537363970.625084440.png',...
    '/Users/lingqiujin/move_short/rgb/1537363970.792661267.png',...
    '/Users/lingqiujin/move_short/rgb/1537363970.961289137.png',...
    '/Users/lingqiujin/move_short/rgb/1537363971.128631828.png',...
    '/Users/lingqiujin/move_short/rgb/1537363971.298071542.png',...
    '/Users/lingqiujin/move_short/rgb/1537363971.465380874.png',...
    '/Users/lingqiujin/move_short/rgb/1537363971.633068634.png',...
    '/Users/lingqiujin/move_short/rgb/1537363971.802059025.png',...
    '/Users/lingqiujin/move_short/rgb/1537363972.001799472.png',...
    '/Users/lingqiujin/move_short/rgb/1537363972.169800929.png',...
    '/Users/lingqiujin/move_short/rgb/1537363972.338397411.png',...
    '/Users/lingqiujin/move_short/rgb/1537363972.505569425.png',...
    '/Users/lingqiujin/move_short/rgb/1537363972.674380513.png',...
    '/Users/lingqiujin/move_short/rgb/1537363972.842241504.png',...
    '/Users/lingqiujin/move_short/rgb/1537363973.010160900.png',...
    '/Users/lingqiujin/move_short/rgb/1537363973.179287309.png',...
    '/Users/lingqiujin/move_short/rgb/1537363973.346007153.png',...
    '/Users/lingqiujin/move_short/rgb/1537363973.513414805.png',...
    };

% Detect checkerboards in images
[imagePoints, boardSize, imagesUsed] = detectCheckerboardPoints(imageFileNames);
imageFileNames = imageFileNames(imagesUsed);
numImages = size(imageFileNames, 2)

%%
% Read the first image to obtain image size
originalImage = imread(imageFileNames{1});
[mrows, ncols, ~] = size(originalImage);

% Generate world coordinates of the corners of the squares
squareSize = 30;  % in units of 'millimeters'
worldPoints = generateCheckerboardPoints(boardSize, squareSize);

rotationVectors = zeros(3, numImages);
translationVectors = zeros(3, numImages); 

% fx = 618.469482421875;
% fy = 618.7632446289062;
% skew = 0;
% cx = 323.09356689453125;
% cy = 237.54339599609375;

fx = 662.348631509985;
fy = 673.158030712524;
skew = 0;
cx = 349.358336125349;
cy = 238.979555744906;

A = [fx, skew, cx; ...
     0, fy, cy; ...
     0, 0, 1];

Ainv = inv(A);

for i = 1:numImages
    H = fitgeotrans(worldPoints, imagePoints(:,:,i), 'projective');
    H = (H.T)';
    H = H / H(3,3);
    
    h1 = H(:, 1);
    h2 = H(:, 2);
    h3 = H(:, 3);
    lambda = 1 / norm(Ainv * h1); %#ok
    
    % 3D rotation matrix
    r1 = lambda * Ainv * h1; %#ok
    r2 = lambda * Ainv * h2; %#ok
    r3 = cross(r1, r2);
    R = [r1,r2,r3];
    
    rotationVectors(:, i) = vision.internal.calibration.rodriguesMatrixToVector(R);
    
    % translation vector
    t = lambda * Ainv * h3;  %#ok
    translationVectors(:, i) = t;
end

rotationVectors = rotationVectors';
translationVectors = translationVectors'/1000;

figure,scatter3(translationVectors(:,1),translationVectors(:,2),translationVectors(:,3))

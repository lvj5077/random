% Auto-generated by cameraCalibrator app on 17-Sep-2018
%-------------------------------------------------------
close all
clear
clc

% Define images to process
imageFileNames = {'/Users/lingqiujin/13_42_45_09_10_2018/rect01/1.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/2.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/3.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/4.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/5.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/6.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/7.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/8.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/9.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/10.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/11.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/12.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/13.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/14.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/15.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/16.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/17.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/18.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/19.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/20.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/21.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/22.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/23.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/24.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/26.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/27.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/28.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/29.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/30.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/31.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/32.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/33.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/34.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/35.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/36.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/37.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/38.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/39.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/40.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/41.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/42.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/43.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/44.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/45.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/46.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/47.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/48.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/49.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/50.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/51.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/52.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/53.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/54.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/55.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/56.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/57.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/58.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/59.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/60.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/61.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/62.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/63.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/64.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/65.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/66.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/67.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/68.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/69.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/70.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/71.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/72.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/73.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/74.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/75.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/76.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/77.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/78.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/79.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/80.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/81.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/82.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/83.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/84.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/85.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/86.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/87.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/88.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/89.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/90.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/91.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/92.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/93.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/94.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/95.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/96.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/97.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/98.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/99.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/100.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/101.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/102.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/103.png',...
    '/Users/lingqiujin/13_42_45_09_10_2018/rect01/104.png',...
    };
% Detect checkerboards in images
[imagePoints, boardSize, imagesUsed] = detectCheckerboardPoints(imageFileNames);
imageFileNames = imageFileNames(imagesUsed);

% Read the first image to obtain image size
originalImage = imread(imageFileNames{1});
[mrows, ncols, ~] = size(originalImage);

% Generate world coordinates of the corners of the squares
squareSize = 50;  % in units of 'millimeters'
worldPoints = generateCheckerboardPoints(boardSize, squareSize);

% Calibrate the camera
[cameraParams, imagesUsed, estimationErrors] = estimateCameraParameters(imagePoints, worldPoints, ...
    'EstimateSkew', false, 'EstimateTangentialDistortion', false, ...
    'NumRadialDistortionCoefficients', 2, 'WorldUnits', 'millimeters', ...
    'InitialIntrinsicMatrix', [], 'InitialRadialDistortion', [], ...
    'ImageSize', [mrows, ncols]);

% % View reprojection errors
% h1=figure; showReprojectionErrors(cameraParams);
% 
% % Visualize pattern locations
% h2=figure; showExtrinsics(cameraParams, 'CameraCentric');
% 
% % Display parameter estimation errors
% displayErrors(estimationErrors, cameraParams);
% 
% % For example, you can use the calibration data to remove effects of lens distortion.
% undistortedImage = undistortImage(originalImage, cameraParams);

% See additional examples of how to use the calibration data.  At the prompt type:
% showdemo('MeasuringPlanarObjectsExample')
% showdemo('StructureFromMotionExample')
%%
formatSpec = '/Users/lingqiujin/13_42_45_09_10_2018/rect02/%d.png';
[~,imgeV] = size(imageFileNames);
for i = 1:imgeV
    originalImage = imread(imageFileNames{i});
    undistortedImage = undistortImage(originalImage, cameraParams);
    path = sprintf(formatSpec,i);
    imwrite(undistortedImage,path);   
end
